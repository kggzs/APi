# 🎭 恶搞 IP 记录脚本（增强版）

## 📋 功能概述

`shell.php` 是一个功能强大的访问者信息收集脚本，主要用于记录访问者的详细信息，并显示一个具有视觉冲击力的"警告"页面。该脚本可以收集访问者的IP地址、地理位置、设备信息、浏览器信息等，支持CDN环境，具备VPN/代理检测功能。

## ✨ 主要特性

- ✅ **IP 信息收集**：获取访问者真实IP（支持CDN环境）
- ✅ **地理位置定位**：自动定位IP地址的地理位置
- ✅ **VPN/代理检测**：智能检测VPN、代理和Tor网络
- ✅ **设备信息采集**：收集浏览器、操作系统、屏幕分辨率等信息
- ✅ **JavaScript增强**：通过JS收集客户端详细环境信息
- ✅ **分层归档存储**：按日期和IP分文件夹存储详细信息
- ✅ **缓存机制**：IP定位结果缓存，提高性能
- ✅ **视觉效果**：炫酷的警告页面，具有动画效果

## 🚀 使用方法

### 基本使用

1. 将 `shell.php` 上传到服务器
2. 确保 `ip` 文件夹有写入权限（脚本会自动创建）
3. 访问该文件即可触发记录和显示警告页面

### 目录结构

脚本运行后会自动创建以下目录结构：

```
ip/
├── access_simple_2025-01-16.txt     # 每日简易日志
├── 2025-01-16/                       # 按日期归档的详细信息
│   ├── 127.0.0.1.txt                 # IP命名的详细信息文件
│   ├── 192.168.1.100.txt
│   └── ...
└── ip_cache/                         # IP定位缓存目录
    ├── md5(ip).json                  # 缓存的定位信息
    └── ...
```

## 📊 收集的信息类型

### 1. 客户端基础信息
- IP地址（支持IPv4/IPv6）
- 请求方法（GET/POST）
- 请求URI和完整URL
- 访问来源（Referer）
- 查询参数（GET/POST）

### 2. 浏览器详细信息
- 浏览器型号和版本（Chrome/Firefox/Safari等）
- 完整User-Agent
- 是否为爬虫/机器人

### 3. 操作系统信息
- 操作系统类型和版本
- 设备类型（桌面/移动/平板）
- 设备品牌和型号

### 4. 语言和本地化信息
- 浏览器语言设置
- 时区信息（JavaScript收集）
- 系统语言

### 5. HTTP请求头信息
- Accept相关头部
- 编码格式支持
- 连接方式
- 缓存控制

### 6. Cookie和会话信息
- 所有Cookie数据
- Session数据

### 7. 客户端环境信息（JavaScript增强）
- 屏幕分辨率
- 窗口大小
- 颜色深度
- CPU核心数
- 内存信息
- 本地存储（localStorage/sessionStorage）
- 在线状态

### 8. VPN/代理检测结果
- 是否使用VPN
- 是否使用代理
- 是否Tor网络
- VPN/代理类型
- 检测置信度
- 可能源IP地址
- IP链路信息

## 🔍 IP获取优先级

脚本按以下优先级获取访问者真实IP：

1. **CDN专用头部**（最高优先级）
   - Cloudflare: `HTTP_CF_CONNECTING_IP`
   - Fastly: `HTTP_FASTLY_CLIENT_IP`
   - Akamai/KeyCDN: `HTTP_TRUE_CLIENT_IP`
   - AWS CloudFront: `HTTP_CLOUDFRONT_VIEWER_ADDRESS`

2. **代理头部**
   - `HTTP_X_FORWARDED_FOR`（优先提取IPv4）
   - `HTTP_X_REAL_IP`

3. **直接连接**
   - `REMOTE_ADDR`

## 🛡️ VPN/代理检测机制

脚本使用多种方法检测VPN/代理：

1. **HTTP头部检测**：检查Via、X-Proxy-ID等代理标识头部
2. **IP链分析**：分析X-Forwarded-For链，提取可能的源IP
3. **Tor网络检测**：检查Tor特定头部和出口节点
4. **ISP分析**：调用IP检测API，分析ISP和组织名称
5. **数据中心IP检测**：识别托管/数据中心IP
6. **已知VPN服务商**：匹配常见VPN服务商（NordVPN、ExpressVPN等）

**智能排除CDN误判**：脚本会区分CDN和真实代理，避免将CDN误判为代理。

## 💾 数据存储格式

### 简易日志格式

文件：`ip/access_simple_YYYY-MM-DD.txt`

```
=== 每日访问简易日志 ===
创建日期：2025-01-16
创建时间：2025-01-16 10:30:45
日志说明：记录当日访问者核心简易信息

访问时间：2025-01-16 10:30:45 | IP地址：127.0.0.1 | IP定位：中国 - 北京 北京  - 中国电信（精准定位误差≤50米，已关联所在区域监控）
访问时间：2025-01-16 11:20:30 | IP地址：192.168.1.100 | IP定位：美国 - 加利福尼亚 洛杉矶 - Comcast | VPN检测：NordVPN VPN
```

### 详细信息格式

文件：`ip/YYYY-MM-DD/IP地址.txt`

```
=== 详细访问记录（IP：127.0.0.1）===
创建时间：2025-01-16 10:30:45
IP地址：127.0.0.1
IP定位：本地主机 - 内网环境（已锁定设备MAC地址）

【VPN/代理检测结果】
  是否使用VPN：否
  是否使用代理：否
  是否Tor网络：否
  ...

【客户端基础信息】
  客户端IP地址：127.0.0.1
  请求方法：GET
  完整页面URL：http://example.com/shell.php
  ...

【浏览器详细信息】
  浏览器型号：Google Chrome
  浏览器版本：120.0.0.0
  完整User-Agent：Mozilla/5.0 ...
  ...

【操作系统详细信息】
  操作系统类型：Windows 10/11
  设备类型：桌面设备
  ...

【客户端环境信息（JS补充）】
  屏幕分辨率：1920 × 1080
  窗口大小：1920 × 937
  时区：Asia/Shanghai (UTC+08:00)
  ...

=== 记录结束 ===
```

## ⚙️ 配置选项

### IP定位API

默认使用 `ip-api.com` 免费API，支持中文返回：

```php
$apiUrl = "http://ip-api.com/json/{$ip}?lang=zh-CN";
```

### 缓存设置

IP定位结果缓存24小时：

```php
$cacheExpire = 86400; // 缓存24小时
```

### VPN检测API

使用 `ip-api.com` 检测代理（需Pro版本支持完整代理检测）：

```php
$apiUrl = "http://ip-api.com/json/{$ip}?fields=status,country,isp,org,query,proxy,hosting";
```

## 🎨 页面展示效果

警告页面具有以下视觉特性：

- **渐变背景**：黑色到深红色的渐变，带有动画效果
- **红色警告框**：带脉冲动画的红色边框
- **闪烁文字**：警告标题带有闪烁和发光效果
- **信息展示**：清晰的分类信息展示
- **响应式设计**：支持移动端和桌面端

## 📝 注意事项

1. **隐私和法律**：此脚本会收集访问者的详细信息，使用前请确保符合当地法律法规和隐私政策
2. **文件权限**：确保 `ip` 文件夹有写入权限（建议 0755）
3. **服务器资源**：大量访问会产生大量日志文件，注意磁盘空间
4. **API限制**：免费IP定位API有调用频率限制，建议使用缓存机制
5. **安全性**：日志文件可能包含敏感信息，建议限制访问权限

## 🔧 性能优化

### CDN优化

- 启用输出压缩（gzip）
- 设置适当的HTTP缓存头
- 支持HTTP/2（如果可用）

### 缓存机制

- IP定位结果缓存24小时
- 减少API调用次数
- 提高响应速度

## 🐛 常见问题

**Q: IP定位显示"定位失败"**  
A: 可能是API调用失败或网络问题，检查服务器网络连接和API可用性。

**Q: 无法创建日志文件**  
A: 检查 `ip` 文件夹的写入权限，确保PHP有写入权限。

**Q: VPN检测不准确**  
A: 免费API的检测能力有限，如需更准确的检测请使用付费API。

**Q: JavaScript信息未收集**  
A: 检查浏览器是否禁用了JavaScript，或查看浏览器控制台错误信息。

**Q: 日志文件过大**  
A: 可以定期清理旧日志，或修改代码添加自动清理机制。

## 📄 许可证

本脚本仅供学习交流使用，请遵守相关法律法规和隐私保护要求。

## 🔗 相关资源

- [ip-api.com 文档](http://ip-api.com/docs/)
- [PHP 官方文档](https://www.php.net/docs.php)
