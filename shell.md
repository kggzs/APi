# 🎭 恶搞 IP 记录脚本（增强版）

## 📋 功能概述

`shell.php` 是一个功能强大的访问者信息收集脚本，主要用于记录访问者的详细信息，并显示一个具有视觉冲击力的"警告"页面。该脚本可以收集访问者的IP地址、地理位置、设备信息、浏览器信息等，支持CDN环境，具备VPN/代理检测功能。

## ✨ 主要特性

- ✅ **IP 信息收集**：获取访问者真实IP（支持CDN环境）
- ✅ **地理位置定位**：自动定位IP地址的地理位置
- ✅ **VPN/代理检测**：智能检测VPN、代理和Tor网络
- ✅ **设备信息采集**：收集浏览器、操作系统、屏幕分辨率等信息
- ✅ **JavaScript增强**：通过JS收集客户端详细环境信息
- ✅ **分层归档存储**：按日期和IP分文件夹存储详细信息
- ✅ **缓存机制**：IP定位结果缓存，提高性能
- ✅ **视觉效果**：真实的系统警告页面，专业的企业风格设计
- ✅ **后台管理系统**：通过 `?admin=密码` 访问管理界面
- ✅ **智能去重**：相同IP重复访问只记录时间，不重复记录详细信息
- ✅ **每日统计**：自动生成每日访问统计文件，包含访问量、IP数量等
- ✅ **性能优化**：API超时优化，快速失败机制，智能跳过不必要的API调用

## 🚀 使用方法

### 基本使用

1. 将 `shell.php` 上传到服务器
2. 确保 `ip` 文件夹有写入权限（脚本会自动创建）
3. 访问该文件即可触发记录和显示警告页面

### 后台管理系统

访问后台管理界面查看日志和统计：

```
shell.php?admin=密码
```

**默认密码**：`admin123`（可在代码开头修改 `$adminPassword` 变量）

**后台功能**：
- 🏠 **首页**：显示数据统计（今日、昨日、累计数据）
- 📁 **简易信息**：查看简短日志文件列表
- 📄 **详细信息**：按日期选择查看IP详细记录
- 📊 **统计信息**：查看每日统计文件

**页面布局**：
- 顶部显示系统名称和案件编号
- 标签页切换不同功能模块
- 支持查看文件内容、按日期筛选等

### 目录结构

脚本运行后会自动创建以下目录结构：

```
ip/
├── access_simple_2025-01-16.txt     # 每日简易日志
├── stats_2025-01-16.txt             # 每日访问统计文件
├── stats_2025-01-16.txt.json        # 统计JSON缓存文件
├── 2025-01-16/                       # 按日期归档的详细信息
│   ├── 127.0.0.1.txt                 # IP命名的详细信息文件
│   ├── 192.168.1.100.txt
│   └── ...
└── ip_cache/                         # IP定位缓存目录（在ip文件夹下）
    ├── md5(ip).json                  # 缓存的定位信息
    └── ...
```

## 📊 收集的信息类型

### 1. 客户端基础信息
- IP地址（支持IPv4/IPv6）
- 请求方法（GET/POST）
- 请求URI和完整URL
- 访问来源（Referer）
- 查询参数（GET/POST）

### 2. 浏览器详细信息
- 浏览器型号和版本（Chrome/Firefox/Safari等）
- 完整User-Agent
- 是否为爬虫/机器人

### 3. 操作系统信息
- 操作系统类型和版本
- 设备类型（桌面/移动/平板）
- 设备品牌和型号

### 4. 语言和本地化信息
- 浏览器语言设置
- 时区信息（JavaScript收集）
- 系统语言

### 5. HTTP请求头信息
- Accept相关头部
- 编码格式支持
- 连接方式
- 缓存控制

### 6. Cookie和会话信息
- 所有Cookie数据
- Session数据

### 7. 客户端环境信息（JavaScript增强）
- 屏幕分辨率
- 窗口大小
- 颜色深度
- CPU核心数
- 内存信息
- 本地存储（localStorage/sessionStorage）
- 在线状态

### 8. VPN/代理检测结果
- 是否使用VPN
- 是否使用代理
- 是否Tor网络
- VPN/代理类型
- 检测置信度
- 可能源IP地址
- IP链路信息

## 🔍 IP获取优先级

脚本按以下优先级获取访问者真实IP：

1. **CDN专用头部**（最高优先级）
   - Cloudflare: `HTTP_CF_CONNECTING_IP`
   - Fastly: `HTTP_FASTLY_CLIENT_IP`
   - Akamai/KeyCDN: `HTTP_TRUE_CLIENT_IP`
   - AWS CloudFront: `HTTP_CLOUDFRONT_VIEWER_ADDRESS`

2. **代理头部**
   - `HTTP_X_FORWARDED_FOR`（优先提取IPv4）
   - `HTTP_X_REAL_IP`

3. **直接连接**
   - `REMOTE_ADDR`

## 🛡️ VPN/代理检测机制

脚本使用多种方法检测VPN/代理：

1. **HTTP头部检测**：检查Via、X-Proxy-ID等代理标识头部
2. **IP链分析**：分析X-Forwarded-For链，提取可能的源IP
3. **Tor网络检测**：检查Tor特定头部和出口节点
4. **ISP分析**：调用IP检测API，分析ISP和组织名称
5. **数据中心IP检测**：识别托管/数据中心IP
6. **已知VPN服务商**：匹配常见VPN服务商（NordVPN、ExpressVPN等）

**智能排除CDN误判**：脚本会区分CDN和真实代理，避免将CDN误判为代理。

## 💾 数据存储格式

### 简易日志格式

文件：`ip/access_simple_YYYY-MM-DD.txt`

```
=== 每日访问简易日志 ===
创建日期：2025-01-16
创建时间：2025-01-16 10:30:45
日志说明：记录当日访问者核心简易信息

访问时间：2025-01-16 10:30:45 | IP地址：127.0.0.1 | IP定位：中国 - 北京 北京  - 中国电信（精准定位误差≤50米，已关联所在区域监控）
访问时间：2025-01-16 11:20:30 | IP地址：192.168.1.100 | IP定位：美国 - 加利福尼亚 洛杉矶 - Comcast | VPN检测：NordVPN VPN
```

### 详细信息格式

文件：`ip/YYYY-MM-DD/IP地址.txt`

**首次访问**：记录完整的详细信息

```
=== 详细访问记录（IP：127.0.0.1）===
创建时间：2025-01-16 10:30:45
IP地址：127.0.0.1
IP定位：本地主机 - 内网环境（已锁定设备MAC地址）

【VPN/代理检测结果】
  是否使用VPN：否
  是否使用代理：否
  是否Tor网络：否
  ...

【客户端基础信息】
  客户端IP地址：127.0.0.1
  请求方法：GET
  完整页面URL：http://example.com/shell.php
  ...

【浏览器详细信息】
  浏览器型号：Google Chrome
  浏览器版本：120.0.0.0
  完整User-Agent：Mozilla/5.0 ...
  ...

【操作系统详细信息】
  操作系统类型：Windows 10/11
  设备类型：桌面设备
  ...

【客户端环境信息（JS补充）】
  屏幕分辨率：1920 × 1080
  窗口大小：1920 × 937
  时区：Asia/Shanghai (UTC+08:00)
  ...

=== 记录结束 ===
```

**重复访问**：仅追加访问时间（不重复记录详细信息）

```
  → 再次访问时间：2025-01-16 14:20:30
  → 再次访问时间：2025-01-16 18:45:12
```

### 每日统计文件格式

文件：`ip/stats_YYYY-MM-DD.txt`

```
=== 每日访问统计 ===
统计日期：2025-01-16
最后更新：2025-01-16 23:59:59
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【访问统计】
总访问次数：125
独立IP数量：58
重复访问次数：67
新访问次数：58

【IP列表】（共 58 个）
  - 127.0.0.1
  - 192.168.1.100
  ...

【最近访问时间】（最近20条，共 125 条）
  - 2025-01-16 23:59:59
  - 2025-01-16 23:55:30
  ...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
说明：本文件自动生成，记录每日访问统计信息
```

## ⚙️ 配置选项

### 管理密码设置

在代码开头修改管理后台密码：

```php
$adminPassword = 'admin123'; // 请修改为您自己的密码
```

访问后台：`shell.php?admin=您的密码`

### IP定位API

默认使用 `ip-api.com` 免费API，支持中文返回：

```php
$apiUrl = "http://ip-api.com/json/{$ip}?lang=zh-CN";
```

**超时设置**：超时1秒，连接超时1秒（快速失败机制）

### 缓存设置

IP定位结果缓存24小时，缓存目录位于 `ip/ip_cache/`：

```php
$cacheDir = 'ip/ip_cache';
$cacheExpire = 86400; // 缓存24小时
```

### VPN检测API

使用 `ip-api.com` 检测代理（需Pro版本支持完整代理检测）：

```php
$apiUrl = "http://ip-api.com/json/{$ip}?fields=status,country,isp,org,query,proxy,hosting";
```

**智能跳过**：如果通过其他方法已检测到VPN/代理/Tor（置信度>50%），自动跳过API调用

## 🎨 页面展示效果

警告页面采用专业的系统警告风格设计：

- **专业配色**：蓝色系主题（#1890ff），类似真实的安全系统
- **清晰布局**：表格化信息展示，正式规范
- **案件编号**：使用中文六角括号格式，如：`国网安罚决字〔2026〕0112号`
- **中文日期**：落款日期使用中文格式，如：`二〇二六年一月十七日`
- **信息展示**：清晰的分类信息展示，包含访问时间、IP地址、地理位置、VPN/代理检测等
- **响应式设计**：支持移动端和桌面端，自适应布局

## 📝 注意事项

1. **隐私和法律**：此脚本会收集访问者的详细信息，使用前请确保符合当地法律法规和隐私政策
2. **文件权限**：确保 `ip` 文件夹有写入权限（建议 0755）
3. **服务器资源**：大量访问会产生大量日志文件，注意磁盘空间
4. **API限制**：免费IP定位API有调用频率限制，建议使用缓存机制
5. **安全性**：日志文件可能包含敏感信息，建议限制访问权限

## 🔧 性能优化

### CDN优化

- 启用输出压缩（gzip）
- 设置适当的HTTP缓存头
- 支持HTTP/2（如果可用）

### 缓存机制

- IP定位结果缓存24小时（存储在 `ip/ip_cache/`）
- 减少API调用次数
- 提高响应速度
- 统计文件使用JSON格式缓存，快速读取和更新

### API调用优化

- **超时设置**：所有API调用超时时间减少到1秒
- **快速失败**：连接超时1秒，快速返回默认值
- **智能跳过**：如果已有足够的检测结果，跳过不必要的API调用
- **禁用重定向**：减少不必要的网络请求

### 数据存储优化

- **智能去重**：相同IP重复访问只记录时间，不重复记录详细信息
- **统计文件**：自动生成每日统计，避免实时计算
- **JSON缓存**：统计文件使用JSON格式存储，提高读写速度

### 页面加载优化

- 预期加载时间：**0-2秒**（正常情况下）
- 如果已检测到VPN/代理 → 立即返回（约0秒）
- 如果需要调用API → 最多1-2秒超时后返回
- 重复IP访问 → 利用缓存，几乎瞬时返回

## 🐛 常见问题

**Q: IP定位显示"定位失败"**  
A: 可能是API调用失败或网络问题，检查服务器网络连接和API可用性。系统会尝试使用缓存数据。

**Q: 无法创建日志文件**  
A: 检查 `ip` 文件夹的写入权限，确保PHP有写入权限（建议0755）。

**Q: VPN检测不准确**  
A: 免费API的检测能力有限，如需更准确的检测请使用付费API。系统会优先使用HTTP头部检测，减少API调用。

**Q: JavaScript信息未收集**  
A: 检查浏览器是否禁用了JavaScript，或查看浏览器控制台错误信息。JavaScript信息会通过异步请求补充。

**Q: 日志文件过大**  
A: 可以定期清理旧日志，或修改代码添加自动清理机制。重复访问不会重复记录详细信息，节省空间。

**Q: 后台管理页面无法打开**  
A: 检查密码是否正确，默认密码为 `admin123`。访问格式：`shell.php?admin=密码`

**Q: 昨日数据无法显示**  
A: 确保统计文件 `stats_YYYY-MM-DD.txt` 存在。系统会自动从JSON缓存或文本文件读取数据。

**Q: 页面加载速度慢**  
A: 系统已优化API超时时间到1秒。如果依然慢，检查网络连接或使用本地缓存。重复访问的IP会使用缓存，速度更快。

**Q: 相同IP被记录多次**  
A: 系统已实现智能去重。相同IP首次访问记录完整信息，后续访问只记录时间，不会重复记录详细信息。

## 📋 更新日志

### 最新版本（2026-01-17）

#### 🎨 界面优化
- ✅ **页面风格升级**：从炫酷红色警告风格改为专业的系统警告风格
  - 采用蓝色系主题（#1890ff），类似真实的企业/政府安全系统
  - 清晰的表格布局和分类展示
  - 移除过度动画效果，使用正式的设计风格

- ✅ **格式规范化**：
  - 案件编号使用中文六角括号：`国网安罚决字〔2026〕0112号`
  - 案件编号基于访问时间：使用小时分钟格式（如 `0112`、`1211`）
  - 日期格式改为中文：`二〇二六年一月十七日`
  - 段落行距固定值 28 磅（CSS line-height: 37px）

#### 🔐 信息标识
- ✅ **备案号**：基于浏览器指纹生成，每个访问者显示不同的备案号
- ✅ **案号**：显示在日期签名区域

#### 📊 后台管理系统
- ✅ **管理界面**：通过 `shell.php?admin=密码` 访问后台
  - 🏠 **首页**：数据统计仪表板（今日、昨日、累计数据）
  - 📁 **简易信息**：简短日志文件列表
  - 📄 **详细信息**：按日期选择查看IP详细记录
  - 📊 **统计信息**：每日统计文件列表

- ✅ **统计功能增强**：
  - 首页显示详细数据统计（今日、昨日、累计）
  - 支持查看所有历史日期
  - 按日期分组展示文件
  - 文件查看功能，支持返回导航

#### 💾 数据存储优化
- ✅ **智能去重**：
  - 相同IP首次访问：记录完整详细信息
  - 相同IP重复访问：仅追加访问时间（`→ 再次访问时间：YYYY-MM-DD HH:MM:SS`）
  - 避免重复记录，节省存储空间

- ✅ **每日统计文件**：
  - 自动生成 `ip/stats_YYYY-MM-DD.txt` 统计文件
  - 包含总访问次数、独立IP数量、重复访问次数、新访问次数
  - 记录所有访问过的IP列表
  - 保存最近访问时间列表
  - 同时生成JSON格式缓存文件，便于快速读取

- ✅ **缓存优化**：
  - IP定位缓存目录移至 `ip/ip_cache/` 文件夹下
  - 统一目录管理，方便维护

#### ⚡ 性能优化
- ✅ **API超时优化**：
  - VPN检测API：超时时间 5秒 → **1秒**，连接超时 3秒 → **1秒**
  - IP定位API：超时时间 5秒 → **1秒**，连接超时 3秒 → **1秒**
  - 禁用重定向，减少不必要的网络请求

- ✅ **智能跳过API调用**：
  - 如果通过HTTP头部等方法已检测到VPN/代理/Tor（置信度>50%），跳过VPN检测API
  - 仅在不确定的情况下才调用API，减少等待时间
  - 预期页面加载时间从 2-10秒 减少到 **0-2秒**

#### 🐛 问题修复
- ✅ 修复单次访问被记录为多次的问题（JavaScript请求不再记录访问次数）
- ✅ 修复昨日数据统计无法显示的问题（优化数据读取逻辑）
- ✅ 修复详细信息页面无法查看昨天日志的问题（优化日期文件夹扫描）
- ✅ 修复后台首页打不开的问题（修正action默认值）

## 📄 许可证

本脚本仅供学习交流使用，请遵守相关法律法规和隐私保护要求。

## 🔗 相关资源

- [ip-api.com 文档](http://ip-api.com/docs/)
- [PHP 官方文档](https://www.php.net/docs.php)
